#!/usr/bin/env bash
# Update flake, test Guard configuration, and prompt to switch

set -e  # Exit on any error

cd ~/dotfiles/

echo "Updating flake..."
nix flake update

echo "Testing Guard configuration..."
sudo nixos-rebuild test --flake .#Guard

if [ $? -eq 0 ]; then
    echo -n "Test successful! Switch to new configuration? [y/N] "
    read -r response
    if [[ "$response" =~ ^[Yy]$ ]]; then
        echo "Switching to new configuration..."
        sudo nixos-rebuild switch --flake .#Guard
        echo "Successfully switched to Guard configuration!"
    else
        echo "Test configuration not applied. You can run 'nrs-guard' later to switch."
    fi
else
    echo "Test failed! Configuration not applied."
    exit 1
fi